# Makefile para Sistema de GestiÃ³n de Inventario
# ===============================================

.PHONY: help install run-console run-web run-api test clean docker-build docker-run-api docker-run-web docker-run-console docker-test docker-stop docker-clean docker-compose-up docker-compose-down docker-compose-logs

# Variables
PYTHON = python3
PIP = pip3
VENV = venv
DOCKER_IMAGE = inventario-sistema
DOCKER_TAG = latest

# ConfiguraciÃ³n por defecto
.DEFAULT_GOAL := help

# Ayuda - muestra todos los comandos disponibles
help: ## ğŸ“‹ Mostrar esta ayuda
	@echo "ğŸ¯ Sistema de GestiÃ³n de Inventario - Comandos Disponibles"
	@echo "=========================================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ“¦ Para empezar rÃ¡pido: make install && make run-web"

# ConfiguraciÃ³n del entorno local
install: ## ğŸ“¥ Instalar dependencias en entorno virtual
	@echo "ğŸ“¥ Instalando dependencias..."
	$(PYTHON) -m venv $(VENV)
	$(VENV)/bin/$(PIP) install --upgrade pip
	$(VENV)/bin/$(PIP) install -r requirements.txt
	@echo "âœ… Dependencias instaladas en $(VENV)/"

install-global: ## ğŸŒ Instalar dependencias globalmente
	@echo "ğŸ“¥ Instalando dependencias globalmente..."
	$(PIP) install -r requirements.txt
	@echo "âœ… Dependencias instaladas globalmente"

# EjecuciÃ³n local (sin Docker)
run-console: ## ğŸ’» Ejecutar interfaz de consola
	@echo "ğŸ’» Iniciando interfaz de consola..."
	$(PYTHON) main.py

run-web: ## ğŸŒ Ejecutar interfaz web (Streamlit) en puerto 8501
	@echo "ğŸŒ Iniciando interfaz web..."
	@echo "ğŸ“ URL: http://localhost:8501"
	streamlit run app_streamlit.py

run-api: ## ğŸš€ Ejecutar API REST en puerto 8000
	@echo "ğŸš€ Iniciando API REST..."
	@echo "ğŸ“ URL: http://localhost:8000"
	@echo "ğŸ“š Docs: http://localhost:8000/docs"
	$(PYTHON) api.py

test: ## ğŸ§ª Ejecutar script de pruebas
	@echo "ğŸ§ª Ejecutando pruebas del sistema..."
	$(PYTHON) test_sistema.py

# Comandos de limpieza
clean: ## ğŸ§¹ Limpiar archivos temporales
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -f *.db
	@echo "âœ… Limpieza completada"

clean-venv: ## ğŸ—‘ï¸ Eliminar entorno virtual
	@echo "ğŸ—‘ï¸ Eliminando entorno virtual..."
	rm -rf $(VENV)
	@echo "âœ… Entorno virtual eliminado"

# Comandos de Docker
docker-build: ## ğŸ³ Construir imagen Docker
	@echo "ğŸ³ Construyendo imagen Docker..."
	docker build -t $(DOCKER_IMAGE):$(DOCKER_TAG) .
	@echo "âœ… Imagen construida: $(DOCKER_IMAGE):$(DOCKER_TAG)"

docker-run-api: docker-build ## ğŸš€ Ejecutar API en Docker (puerto 8000)
	@echo "ğŸš€ Ejecutando API en Docker..."
	@echo "ğŸ“ URL: http://localhost:8000"
	@echo "ğŸ“š Docs: http://localhost:8000/docs"
	docker run -p 8000:8000 --name inventario-api-container $(DOCKER_IMAGE):$(DOCKER_TAG) api

docker-run-web: docker-build ## ğŸŒ Ejecutar Streamlit en Docker (puerto 8501)
	@echo "ğŸŒ Ejecutando interfaz web en Docker..."
	@echo "ğŸ“ URL: http://localhost:8501"
	docker run -p 8501:8501 --name inventario-web-container $(DOCKER_IMAGE):$(DOCKER_TAG) web

docker-run-console: docker-build ## ğŸ’» Ejecutar consola en Docker (interactivo)
	@echo "ğŸ’» Ejecutando interfaz de consola en Docker..."
	docker run -it --name inventario-console-container $(DOCKER_IMAGE):$(DOCKER_TAG) console

docker-test: docker-build ## ğŸ§ª Ejecutar pruebas en Docker
	@echo "ğŸ§ª Ejecutando pruebas en Docker..."
	docker run --name inventario-test-container $(DOCKER_IMAGE):$(DOCKER_TAG) test

docker-stop: ## â¹ï¸ Detener todos los contenedores
	@echo "â¹ï¸ Deteniendo contenedores..."
	-docker stop inventario-api-container inventario-web-container inventario-console-container inventario-test-container
	-docker rm inventario-api-container inventario-web-container inventario-console-container inventario-test-container
	@echo "âœ… Contenedores detenidos"

docker-clean: docker-stop ## ğŸ§¹ Limpiar imÃ¡genes y contenedores Docker
	@echo "ğŸ§¹ Limpiando recursos Docker..."
	-docker rmi $(DOCKER_IMAGE):$(DOCKER_TAG)
	docker system prune -f
	@echo "âœ… Limpieza Docker completada"

# Comandos de Docker Compose
docker-compose-up: ## ğŸ¼ Levantar todos los servicios con Docker Compose
	@echo "ğŸ¼ Levantando servicios con Docker Compose..."
	@echo "ğŸ“ API: http://localhost:8000"
	@echo "ğŸ“ Web: http://localhost:8501"
	mkdir -p data
	docker-compose up --build

docker-compose-up-detached: ## ğŸ¼ Levantar servicios en segundo plano
	@echo "ğŸ¼ Levantando servicios en segundo plano..."
	mkdir -p data
	docker-compose up --build -d
	@echo "âœ… Servicios ejecutÃ¡ndose en segundo plano"
	@echo "ğŸ“ API: http://localhost:8000"
	@echo "ğŸ“ Web: http://localhost:8501"

docker-compose-down: ## â¹ï¸ Detener servicios de Docker Compose
	@echo "â¹ï¸ Deteniendo servicios..."
	docker-compose down
	@echo "âœ… Servicios detenidos"

docker-compose-logs: ## ğŸ“‹ Ver logs de los servicios
	@echo "ğŸ“‹ Mostrando logs de los servicios..."
	docker-compose logs -f

docker-compose-test: ## ğŸ§ª Ejecutar pruebas con Docker Compose
	@echo "ğŸ§ª Ejecutando pruebas con Docker Compose..."
	docker-compose --profile testing up --build inventario-test

# Comandos de desarrollo
dev-setup: install ## ğŸ› ï¸ ConfiguraciÃ³n completa para desarrollo
	@echo "ğŸ› ï¸ Configurando entorno de desarrollo..."
	@echo "âœ… Entorno listo para desarrollo"
	@echo "ğŸ’¡ Comandos Ãºtiles:"
	@echo "   make run-web    - Interfaz web"
	@echo "   make run-api    - API REST"
	@echo "   make test       - Ejecutar pruebas"

# Comandos de producciÃ³n
prod-docker: docker-compose-up-detached ## ğŸš€ Desplegar en producciÃ³n con Docker
	@echo "ğŸš€ Sistema desplegado en producciÃ³n"
	@echo "ğŸ“ Servicios disponibles:"
	@echo "   API: http://localhost:8000"
	@echo "   Web: http://localhost:8501"

# InformaciÃ³n del sistema
info: ## â„¹ï¸ Mostrar informaciÃ³n del sistema
	@echo "â„¹ï¸ InformaciÃ³n del Sistema de Inventario"
	@echo "========================================"
	@echo "ğŸ“ Directorio: $(PWD)"
	@echo "ğŸ Python: $(shell $(PYTHON) --version 2>&1)"
	@echo "ğŸ“¦ Pip: $(shell $(PIP) --version 2>&1)"
	@echo "ğŸ³ Docker: $(shell docker --version 2>&1 || echo 'No instalado')"
	@echo "ğŸ¼ Docker Compose: $(shell docker-compose --version 2>&1 || echo 'No instalado')"
	@echo ""
	@echo "ğŸ“Š Archivos del proyecto:"
	@ls -la *.py requirements.txt 2>/dev/null || echo "âŒ Archivos no encontrados"

# Comandos rÃ¡pidos
quick-start: docker-compose-up-detached ## âš¡ Inicio rÃ¡pido (Docker Compose en segundo plano)

quick-stop: docker-compose-down ## âš¡ Parada rÃ¡pida

restart: docker-compose-down docker-compose-up-detached ## ğŸ”„ Reiniciar servicios 